# Rotire

![Rotire Logo](./rotire.png)

Rotire is a command-line file rotation tool written in Rust that helps manage file cleanup and archival in directories. It's designed to maintain a specified number of the most recent files while handling older files through archival or deletion.

## What does Rotire do?

Rotire automatically manages files in a directory by:
- **Keeping the N newest files** (configurable, default: 4)
- **Archiving older files** into timestamped tar.gz archives (default behavior)
- **Deleting older files** permanently (when using delete action)
- **Filtering files** by prefix or suffix patterns (optional)

### Use Cases
- **Log rotation**: Archive old log files while keeping recent ones accessible
- **Backup management**: Clean up backup directories by archiving old backups
- **Photo organization**: Manage large photo directories by archiving older images
- **Build artifacts**: Clean up build directories while preserving recent builds

## How it works

1. Scans the specified directory for files
2. Applies optional prefix/suffix filters
3. Sorts files by modification time (oldest first)
4. Keeps the N most recent files untouched
5. Archives remaining files into a timestamped tar.gz file OR deletes them permanently

# Usage

```
Simple program to rotate files

Usage: rotire [OPTIONS] --directory <DIRECTORY> [ACTION]

Arguments:
  [ACTION]  Select the action rotire should run. [default: archive] [possible values: archive, delete]

Options:
  -d, --directory <DIRECTORY>          Path of the directory on which rotire should run
  -k, --keep-n <KEEP_N>                How many items to keep, defaults to 4 [default: 4]
  -p, --prefix-filter <PREFIX_FILTER>  Only apply action on the file names matching the prefix
  -s, --suffix-filter <SUFFIX_FILTER>  Only apply action on the file names matching the suffix
  -h, --help                           Print help
  -V, --version                        Print version
```

## Examples

### Basic Usage
```bash
# Archive old files, keep 4 newest
rotire --directory /home/denis/Pictures/not_in_train

# Delete old files instead of archiving
rotire --directory /path/to/logs delete

# Keep 10 most recent files
rotire --directory /path/to/backups --keep-n 10

# Only process files with specific prefix
rotire --directory /path/to/files --prefix-filter "backup-"

# Only process files with specific suffix
rotire --directory /path/to/files --suffix-filter ".log"

# Combine filters and actions
rotire --directory /var/log --suffix-filter ".log" --keep-n 7 delete
```

# Directory Structure

```
rotire/
├── Cargo.toml          # Project configuration and dependencies
├── Cargo.lock          # Dependency lock file
├── readme.md           # This file
├── rotire.png          # Project logo
├── src/
│   ├── main.rs         # Entry point, CLI argument parsing
│   └── rotire/
│       ├── mod.rs      # Core Rotire struct and business logic
│       ├── model.rs    # Data structures (RotireFile, RotireResult)
│       └── filter.rs   # File filtering system (prefix/suffix)
└── target/             # Build artifacts (generated by cargo)
```

## Architecture Overview

### Core Components

- **`main.rs`**: CLI interface using clap for argument parsing
- **`rotire/mod.rs`**: Main `Rotire` struct containing file processing logic
- **`rotire/model.rs`**: Data models for files and operation results
- **`rotire/filter.rs`**: File filtering system for prefix/suffix matching

### Key Concepts

- **RotireAction**: Enum defining operations (Archive, Delete)
- **RotireFilter**: Enum for file filtering (Prefix, Suffix)
- **Atomic Operations**: Prevents concurrent runs using AtomicBool
- **Timestamped Archives**: Creates `rotire-archive-{timestamp}.tar.gz` files

# Development

## Prerequisites

- Rust 1.70+ (2021 edition)
- Cargo (comes with Rust)

## Building

```bash
# Debug build
cargo build

# Release build (optimized)
cargo build --release

# Quick compile check
cargo check
```

## Running

```bash
# Run with cargo
cargo run -- --directory /path/to/test/dir

# Run built binary
./target/release/rotire --directory /path/to/test/dir
```

## Development Commands

```bash
# Format code
cargo fmt

# Lint code
cargo clippy

# Run tests
cargo test

# Generate documentation
cargo doc --open
```

## Dependencies

- **clap**: Command-line argument parsing with derive macros
- **tar**: TAR archive creation
- **flate2**: Gzip compression for archives
- **anyhow**: Simplified error handling
- **log + env_logger**: Logging infrastructure

## Contributing

1. Fork the repository
2. Create a feature branch (`git checkout -b feature/amazing-feature`)
3. Make your changes
4. Run tests and ensure code quality:
   ```bash
   cargo test
   cargo fmt
   cargo clippy
   ```
5. Commit your changes (`git commit -m 'Add amazing feature'`)
6. Push to the branch (`git push origin feature/amazing-feature`)
7. Open a Pull Request

## Safety and Considerations

- **Backup Important Data**: Always test on non-critical directories first
- **Archive Location**: Archives are created in the same directory being processed
- **File Permissions**: Ensure proper read/write permissions for the target directory
- **Concurrent Execution**: Built-in protection prevents multiple simultaneous runs
- **Error Handling**: Failed operations are logged but don't stop the entire process

## License

This project is open source. Please check the repository for license information.